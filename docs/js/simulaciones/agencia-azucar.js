// Extraído del inline de agencia-azucar.html
function randUniformInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
function randExponential(mean){const u=Math.random();return -mean*Math.log(1-u);} 
function format(num,dec=2){return num.toLocaleString('es-VE',{minimumFractionDigits:dec,maximumFractionDigits:dec});}
function simularInventario(params){const {horizonte,demandaMedia,periodoRevision,ltMin,ltMax,capacidad,costoOrden,costoMantener,costoCompra,precioVenta}=params;let inventario=capacidad;let pedidos=0,costoOrdenarTotal=0,costoMantenerTotal=0,costoCompraTotal=0,ingresosTotal=0;let demandaTotal=0,ventasTotal=0,perdidasTotal=0,inventarioMax=inventario,sumaInventarioPromedioDia=0;let pedidoPendiente=null;if(capacidad>0){costoCompraTotal+=capacidad*costoCompra;costoOrdenarTotal+=costoOrden;pedidos+=1;}for(let dia=1;dia<=horizonte;dia++){const esDomingo=(dia%periodoRevision)===0;if(pedidoPendiente&&dia===pedidoPendiente.llegaDia){const cantRecibida=Math.min(pedidoPendiente.cantidad,capacidad-inventario);inventario+=cantRecibida;costoCompraTotal+=cantRecibida*costoCompra;pedidoPendiente=null;if(inventario>inventarioMax)inventarioMax=inventario;}const inventarioInicio=inventario;if(esDomingo){const hueco=capacidad-inventario;if(hueco>0){const qtyPedido=hueco;const lead=randUniformInt(ltMin,ltMax);pedidoPendiente={cantidad:qtyPedido,llegaDia:dia+lead};pedidos++;costoOrdenarTotal+=costoOrden;}}let demanda=esDomingo?0:Math.round(randExponential(demandaMedia));if(demanda<0)demanda=0;demandaTotal+=demanda;const ventas=Math.min(demanda,inventario);const perdidas=demanda-ventas;ventasTotal+=ventas;perdidasTotal+=perdidas;inventario-=ventas;const inventarioPromedioDia=(inventarioInicio+inventario)/2;sumaInventarioPromedioDia+=inventarioPromedioDia;costoMantenerTotal+=inventarioPromedioDia*costoMantener;ingresosTotal+=ventas*precioVenta;if(inventario>inventarioMax)inventarioMax=inventario;}const gananciaNeta=ingresosTotal-(costoOrdenarTotal+costoMantenerTotal+costoCompraTotal);const inventarioPromedio=sumaInventarioPromedioDia/horizonte;const utilizacionMaxPct=(inventarioMax/capacidad)*100;return {pedidos,demandaTotal,ventasTotal,perdidasTotal,costoOrdenarTotal,costoMantenerTotal,costoCompraTotal,ingresosTotal,gananciaNeta,utilizacionMaxPct,inventarioPromedio};}
function ejecutarSimulaciones(){let nsim=parseInt(document.getElementById('nsim').value)||0;if(nsim<1)nsim=1;let horizonte=parseInt(document.getElementById('horizonte').value)||0;if(horizonte<1)horizonte=60;let demandaMedia=parseFloat(document.getElementById('demandaMedia').value)||0;if(demandaMedia<0)demandaMedia=0;let periodoRevision=parseInt(document.getElementById('periodoRevision').value)||0;if(periodoRevision<1)periodoRevision=7;let ltMin=parseInt(document.getElementById('ltMin').value)||0;if(ltMin<0)ltMin=0;let ltMax=parseInt(document.getElementById('ltMax').value)||0;if(ltMax<ltMin)ltMax=ltMin;let capacidad=parseInt(document.getElementById('capacidad').value)||0;if(capacidad<0)capacidad=0;let costoOrden=parseFloat(document.getElementById('costoOrden').value)||0;if(costoOrden<0)costoOrden=0;let costoMantener=parseFloat(document.getElementById('costoMantener').value)||0;if(costoMantener<0)costoMantener=0;let costoCompra=parseFloat(document.getElementById('costoCompra').value)||0;if(costoCompra<0)costoCompra=0;let precioVenta=parseFloat(document.getElementById('precioVenta').value)||0;if(precioVenta<0)precioVenta=0;const params={horizonte,demandaMedia,periodoRevision,ltMin,ltMax,capacidad,costoOrden,costoMantener,costoCompra,precioVenta};const tbody=document.querySelector('#tablaResultados tbody');tbody.innerHTML='';const resultados=[];for(let i=1;i<=nsim;i++){resultados.push(simularInventario(params));}resultados.forEach((r,idx)=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${idx+1}</td><td>${r.pedidos}</td><td>${format(r.demandaTotal,0)}</td><td>${format(r.ventasTotal,0)}</td><td>${format(r.perdidasTotal,0)}</td><td>${format(r.costoOrdenarTotal)}</td><td>${format(r.costoMantenerTotal)}</td><td>${format(r.costoCompraTotal)}</td><td>${format(r.ingresosTotal)}</td><td class="${r.gananciaNeta>=0?'good':'bad'}">${format(r.gananciaNeta)}</td><td>${format(r.utilizacionMaxPct,2)}%</td>`;tbody.appendChild(tr);});renderKPIs(resultados);}function renderKPIs(res){if(!res.length)return;const kpis=document.getElementById('kpis');kpis.innerHTML='';const sum=res.reduce((a,r)=>{a.gn+=r.gananciaNeta;a.perdidas+=r.perdidasTotal;a.demanda+=r.demandaTotal;a.ventas+=r.ventasTotal;a.invProm+=r.inventarioPromedio;return a;},{gn:0,perdidas:0,demanda:0,ventas:0,invProm:0});const nivelServicio=sum.demanda?(sum.ventas/sum.demanda)*100:0;const gananciaProm=sum.gn/res.length;const inventarioPromedioGlobal=sum.invProm/res.length;const perdidaRelativa=sum.demanda?(sum.perdidas/sum.demanda):0;const capacidadSuficiente=perdidaRelativa<0.02?'Sí':'No';const chips=[{label:'Ganancia neta promedio',value:`Bs ${format(gananciaProm)}`,cls:gananciaProm>=0?'good':'bad'},{label:'Demanda insatisfecha total',value:`${format(sum.perdidas,0)} Kg`,cls:sum.perdidas>0?'warn':''},{label:'Nivel de servicio (%)',value:`${format(nivelServicio,2)} %`,cls:nivelServicio>=98?'good':(nivelServicio>=90?'':'warn')},{label:'Inventario promedio (Kg)',value:`${format(inventarioPromedioGlobal,2)} Kg`},{label:'¿Capacidad suficiente?',value:capacidadSuficiente,cls:capacidadSuficiente==='Sí'?'good':'bad'}];chips.forEach(c=>{const div=document.createElement('div');div.className='chip';div.innerHTML=`<span class="summary-label">${c.label}</span><span class="summary-value ${c.cls||''}">${c.value}</span>`;kpis.appendChild(div);});}function limpiar(){document.querySelector('#tablaResultados tbody').innerHTML='';document.getElementById('kpis').innerHTML='';}document.addEventListener('DOMContentLoaded',()=>{document.getElementById('btnSimular').addEventListener('click',ejecutarSimulaciones);document.getElementById('btnLimpiar').addEventListener('click',limpiar);});
